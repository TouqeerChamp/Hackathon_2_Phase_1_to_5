# CLAUDE.md - Constitution for Phase II Full-Stack Development

This is the supreme law for developing the Phase II Todo Full-Stack Web Application. All rules are binding.

---

## ARTICLE I: STRICT PATH COMPLIANCE

**Law**: All API endpoints MUST follow the `/api/{user_id}/tasks` pattern as defined in the Hackathon Phase II document.

**Violations**:
- Using `/tasks` without user_id is unconstitutional
- Using `/api/tasks` instead of `/api/{user_id}/tasks` is a violation
- Any endpoint not matching the approved pattern is invalid

**Approved Endpoints**:
```
GET    /api/{user_id}/tasks           # List user's tasks
GET    /api/{user_id}/tasks/{id}      # Get single task
POST   /api/{user_id}/tasks           # Create task
PUT    /api/{user_id}/tasks/{id}      # Update task
PATCH  /api/{user_id}/tasks/{id}/toggle  # Toggle completion
DELETE /api/{user_id}/tasks/{id}      # Delete task
```

---

## ARTICLE II: TECH STACK ENFORCEMENT

### Backend Stack (MANDATORY)
| Component | Approved Technology |
|-----------|---------------------|
| Framework | FastAPI |
| ORM | SQLModel (NOT SQLAlchemy, NOT Drizzle) |
| Database | Neon DB (PostgreSQL) |
| Auth | JWT with python-jose |

**Violations**:
- Using SQLAlchemy instead of SQLModel = violation
- Using Drizzle ORM = violation
- Using any other database provider = violation
- Using any other auth library = violation

### Frontend Stack (MANDATORY)
| Component | Approved Technology |
|-----------|---------------------|
| Framework | Next.js 15 (App Router) |
| Auth | Better Auth (JWT-based) |
| Language | TypeScript |
| Styling | Tailwind CSS |

**Violations**:
- Using Pages Router instead of App Router = violation
- Using custom auth instead of Better Auth = violation
- Using JavaScript instead of TypeScript = violation

---

## ARTICLE III: IDENTITY STRATEGY (UUID MANDATE)

**Law**: User IDs must be treated as `String/UUID` throughout the entire system.

**Enforcement**:
| Layer | Type |
|-------|------|
| Database | UUID / String (NOT Integer) |
| API Path | String / UUID |
| API Response | String / UUID |
| Frontend State | String / UUID |
| JWT Claims | String / UUID |

**Violations**:
- Using Integer user_id = violation
- Using auto-incrementing integers for user identification = violation
- Inconsistent ID types between layers = violation

**Example**:
```python
# CORRECT - UUID for user identification
user_id: str = Field(default_factory=lambda: str(uuid.uuid4()))

# INCORRECT - Integer ID (PROHIBITED)
user_id: int = Field(default=None, primary_key=True)  # VIOLATION
```

---

## ARTICLE IV: AGENTIC WORKFLOW (STRICT ORDER)

### Phase Order: PLAN → SPECS → TASKS → IMPLEMENT → VERIFY

**Step 1: PLAN**
- Never implement before `specs/plan.md` is generated
- Plan must contain all milestones with dependencies

**Step 2: SPECS**
- Never generate code before specs are written
- Specs must cover: API, Database, Features, Auth

**Step 3: TASKS**
- Never implement before `specs/tasks/milestoneX.md` exists
- Each task must have:
  - Description
  - Steps
  - Acceptance Criteria (checklist format)

**Step 4: IMPLEMENT**
- Generate code ONLY from approved specs
- No manual coding without spec coverage
- Follow the exact code patterns in specs

**Step 5: VERIFY**
- After every implementation step, verify against "Acceptance Criteria"
- Check against Article I (path compliance)
- Check against Article II (tech stack)
- Check against Article III (UUID mandate)

---

## ARTICLE V: NO MANUAL CODE RULE

**Law**: All code must be generated by the agent based on approved specs.

**Prohibitions**:
- Writing code not defined in a spec = violation
- Manual code changes without spec update = violation
- Refactoring without updating architectural specs = violation
- Adding features not in specs = violation

**Procedure**:
1. Read the relevant spec
2. Generate code from spec
3. Verify code matches spec exactly
4. If spec is wrong, fix spec first, then regenerate code

---

## ARTICLE VI: CONTEXT SEPARATION

### /backend Context
- Language: Python 3.12+
- Framework: FastAPI
- Models: SQLModel classes
- Auth: JWT via python-jose
- Imports: NEVER import frontend code

### /frontend Context
- Language: TypeScript
- Framework: Next.js 15 (App Router)
- Auth: Better Auth
- Data: REST API calls only (NO direct DB access)

### /specs Context
- Single source of truth
- Must always match implementation
- All paths relative to project root

---

## ARTICLE VII: HACKATHON DOCUMENT COMPLIANCE

**Law**: The "Phase II: Todo Full-Stack Web Application" document is the core programming specification. All implementation must match its requirements exactly.

### Section 1: Feature Scope

**Rule**: Only implement features defined in the Hackathon document.

- **No Bonus Features**: Do not add features not explicitly specified
- **No Scope Creep**: Stick to the documented functional requirements
- **Feature Parity**: Every feature in the doc must be implemented
- **Documentation Authority**: The doc takes precedence over external conventions

**Examples**:
- Implementing JWT Shared Secret auth = Required
- Adding OAuth2 Google login = NOT ALLOWED (unless doc specifies)
- Task CRUD operations = Required
- Adding task categories/tags = NOT ALLOWED

### Section 2: Error Handling Standards

**Rule**: HTTP status codes and error messages MUST match the Hackathon document.

| Status Code | Condition | Doc Requirement |
|-------------|-----------|-----------------|
| 400 | Bad Request | Invalid request data |
| 401 | Unauthorized | Missing or invalid JWT token |
| 403 | Forbidden | Accessing another user's resource |
| 404 | Not Found | Resource doesn't exist |
| 422 | Unprocessable Entity | Validation error |
| 500 | Internal Server Error | Server error |

**Response Format**:
```json
// Error responses MUST follow this pattern
{
  "detail": "Error message as specified in doc"
}

// Validation errors
{
  "detail": [
    {
      "loc": ["body", "field_name"],
      "msg": "error message",
      "type": "error_type"
    }
  ]
}
```

### Section 3: UUID & Path Requirements (DOC OVERRIDE)

**Rule**: The Hackathon document's UUID and path requirements override standard REST conventions.

- `/api/{user_id}/tasks` pattern = MANDATORY (not `/tasks`)
- User IDs as UUID = MANDATORY (not auto-increment integers)
- Path parameters MUST match doc exactly

**Do NOT**:
- Use RESTful best practices that conflict with doc
- Add HATEOAS links unless doc specifies
- Use different endpoint naming conventions

### Section 4: Response Structure Compliance

**Rule**: API responses MUST match the documented structure exactly.

**Example - User Registration Response (from doc)**:
```json
{
  "message": "User registered successfully",
  "user": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "user@example.com",
    "created_at": "2025-01-01T10:00:00Z"
  }
}
```

**Example - Task List Response (from doc)**:
```json
{
  "tasks": [
    {
      "id": 1,
      "user_id": "550e8400-e29b-41d4-a716-446655440000",
      "title": "Buy groceries",
      "description": "Milk, eggs, bread",
      "completed": false,
      "created_at": "2025-01-01T10:00:00Z",
      "updated_at": "2025-01-01T10:00:00Z"
    }
  ],
  "total": 1
}
```

### Section 5: Verification Protocol

**Before marking ANY task complete**:
1. [ ] Feature matches doc exactly
2. [ ] No extra features added
3. [ ] Status codes match doc (401, 403, 422, etc.)
4. [ ] Response structures match doc
5. [ ] UUID paths used as specified
6. [ ] Error messages match doc

**Violations**:
| Violation | Penalty |
|-----------|---------|
| Adding unrequested features | Reject, remove extras |
| Wrong status code | Fix to match doc |
| Different response structure | Match doc structure exactly |
| Non-compliant error message | Use doc's error text |
| Ignoring doc requirements | Halt, consult doc |

---

## ARTICLE VIII: AGENTIC DESIGN

**Law**: All code must be written with "Machine Readability" in mind. API responses must be consistent so AI Agents can parse them easily.

### Section 1: OpenAPI Documentation for Agents

**Rule**: Every endpoint MUST have detailed docstrings and OpenAPI descriptions for AI Agent skill discovery.

**Requirements**:
- Use FastAPI's `doc` parameter in route decorators
- Include detailed description of what the endpoint does
- Document expected inputs and output formats
- Tag endpoints for Agent discovery in Swagger UI

**Example**:
```python
@app.get(
    "/api/{user_id}/tasks",
    tags=["Agent Skills"],
    summary="List User Tasks",
    description=(
        "Retrieve all tasks for a specific user. "
        "Returns an array of task objects with id, title, description, completed status, "
        "and timestamps. Supports filtering by completed status via ?completed=true|false "
        "and search via ?search=keyword."
    )
)
async def list_tasks(user_id: UUID, ...):
    ...
```

### Section 2: Machine-Readable Responses

**Rule**: All API responses MUST be consistent and predictable for Agent parsing.

**Response Consistency**:
- Error responses always follow the same structure: `{"detail": "error message"}`
- Validation errors: `{"detail": [...]}`
- Success responses include all expected fields
- No HTML error pages (always return JSON)

**Example - Consistent Error Format**:
```json
{
  "detail": "Task not found"
}
```

### Section 3: Agent Skills Directory

**Rule**: Create `backend/src/agent/` directory with skill definitions for AI agents.

**Required Files**:
```
backend/src/agent/
├── __init__.py           # Skill exports
├── skills.py            # JSON skill definitions
└── prompts.py           # System prompts for agent usage
```

**Skills Schema (JSON format for agent consumption)**:
```json
{
  "skill_name": "todo_tasks",
  "description": "Manage user tasks in the Todo application",
  "endpoints": [
    {
      "method": "GET",
      "path": "/api/{user_id}/tasks",
      "description": "List all tasks for a user"
    },
    {
      "method": "POST",
      "path": "/api/{user_id}/tasks",
      "description": "Create a new task"
    }
  ]
}
```

### Section 4: Swagger UI Agent Discovery

**Rule**: Configure Swagger UI (`/docs`) for optimal Agent discovery.

**Requirements**:
- Use `tags=["Agent Skills"]` for task endpoints
- Add meaningful summaries and descriptions
- Group agent-accessible endpoints together
- Ensure all endpoints are documented

### Section 5: Verification Protocol

**Before marking Agent tasks complete**:
1. [ ] All endpoints have detailed docstrings
2. [ ] OpenAPI descriptions explain inputs/outputs
3. [ ] Swagger UI tags include "Agent Skills"
4. [ ] Response formats are consistent
5. [ ] `backend/src/agent/` directory exists
6. [ ] Skills defined in machine-readable format
7. [ ] System prompts explain agent usage

**Violations**:
| Violation | Penalty |
|-----------|---------|
| Missing endpoint docstrings | Add detailed documentation |
| Inconsistent response format | Standardize to JSON format |
| No agent/skill directory | Create `backend/src/agent/` |
| Non-machine-readable errors | Convert to JSON errors |

---

## DIRECTORY STRUCTURE

```
/
├── CLAUDE.md                    # Supreme Constitution
├── specs/
│   ├── overview.md              # Project goals & tech stack
│   ├── plan.md                  # Milestone roadmap
│   ├── database/
│   │   └── schema.md            # SQLModel definitions
│   ├── api/
│   │   └── rest-endpoints.md    # API endpoints (UUID paths)
│   ├── features/
│   │   ├── task-crud.md         # User stories
│   │   └── authentication.md    # JWT strategy
│   └── tasks/
│       ├── milestone1.md        # Backend Foundation
│       ├── milestone2.md        # Auth Logic
│       ├── milestone3.md        # Task CRUD
│       ├── milestone4.md        # Frontend Setup
│       ├── milestone5.md        # UI Integration
│       └── milestone6.md        # Agent Integration (Skills)
├── backend/                     # FastAPI + SQLModel + Neon DB
│   ├── src/
│   │   ├── models/              # User (UUID), Task (UUID FK)
│   │   ├── schemas/             # Pydantic request/response
│   │   ├── routers/             # API route handlers
│   │   ├── auth/                # JWT utilities
│   │   ├── agent/               # Agent/Skill definitions (Article VIII)
│   │   └── main.py              # Entry point
│   └── requirements.txt
└── frontend/                    # Next.js 15 + Better Auth
    ├── src/
    │   ├── app/                 # App Router pages
    │   ├── components/          # React components
    │   ├── lib/                 # API client (UUID handling)
    │   └── types/               # TypeScript definitions (UUID)
    └── package.json
```

---

## VERIFICATION CHECKLIST

Before marking any task complete, verify:

- [ ] **Path Compliance**: Endpoints use `/api/{user_id}/tasks` pattern
- [ ] **Tech Stack**: Using SQLModel (not SQLAlchemy/Drizzle)
- [ ] **Identity**: User IDs are UUID/String, not Integer
- [ ] **Spec Coverage**: Code matches spec exactly
- [ ] **Tests Passing**: All acceptance criteria verified
- [ ] **No TODO**: No placeholder or FIXME comments
- [ ] **Frontend/Backend Sync**: Types and APIs are consistent

**Article VII - Hackathon Doc Compliance**:
- [ ] Feature matches doc exactly
- [ ] No bonus features added
- [ ] Status codes match doc (401, 403, 422, 404)
- [ ] Response structures match doc
- [ ] Error messages follow doc standards

**Article VIII - Agentic Design**:
- [ ] All endpoints have detailed docstrings
- [ ] OpenAPI descriptions explain inputs/outputs
- [ ] Swagger UI tags include "Agent Skills"
- [ ] Response formats are consistent (machine-readable)
- [ ] `backend/src/agent/` directory created
- [ ] Skills defined in machine-readable format
- [ ] System prompts explain agent usage

---

## VIOLATION PENALTIES

| Violation | Penalty |
|-----------|---------|
| Wrong API path | Reject implementation, fix paths |
| Wrong ORM (SQLAlchemy) | Reject, rewrite with SQLModel |
| Wrong ID type (Integer) | Reject, convert to UUID |
| Code before plan | Stop, generate plan first |
| Code before tasks | Stop, generate tasks first |
| Manual code (no spec) | Reject, create spec first |

---

**This constitution is supreme. All implementation must conform.**

*Ratified: Phase II - Full-Stack Web Application*
